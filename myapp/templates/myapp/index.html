<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calorie Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar {
      border-radius: 0.5rem;
    }

    .progress-bar {
      font-weight: bold;
      transition: width 0.6s ease;
    }

    .table thead th {
      text-align: center;
    }

    .table td,
    .table th {
      text-align: center;
      vertical-align: middle;
    }

    .card {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    h4 {
      margin-bottom: 1rem;
    }

    .form-label {
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-4 mb-4">
      <a class="navbar-brand fw-bold fs-4" href="#">ðŸ¥— Calorie Tracker</a>
    </nav>

    <div class="mb-4">
      <h4 class="text-secondary">Daily Calorie Progress</h4>
      <div class="progress" style="height: 30px;">
        <div class="progress-bar bg-success" id="calorieProgressBar" role="progressbar" style="width: 0%;" aria-valuenow="0"
          aria-valuemin="0" aria-valuemax="100">0%</div>
      </div>
    </div>

    <form method="POST" class="mb-5">
      {% csrf_token %}
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <label class="form-label"><b>Select Food to Add</b></label>
        </div>
        <div class="col-md-6">
          <select class="form-select" name="food_consumed" id="food_consumed">
            {% for food in foods %}
            <option value="{{food.name}}">{{food.name}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-success w-100" type="submit">Add to Consumption</button>
        </div>
      </div>
    </form>

    <div class="row">
      <!-- Left: Table -->
      <div class="col-md-7 mb-4">
        <h4 class="text-secondary">Today's Consumption</h4>
        <div class="table-responsive">
          <table id="table" class="table table-hover table-striped table-bordered">
            <thead class="table-primary">
              <tr>
                <th>Food Item</th>
                <th>Carbs (g)</th>
                <th>Protein (g)</th>
                <th>Fats (g)</th>
                <th>Calories (Kcal)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for c in consumed_food %}
              <tr>
                <td>{{c.food_consumed.name}}</td>
                <td>{{c.food_consumed.carbs}}</td>
                <td>{{c.food_consumed.protien}}</td>
                <td>{{c.food_consumed.fats}}</td>
                <td>{{c.food_consumed.calories}}</td>
                <td>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'delete' c.id %}">Remove</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="fw-bold table-light">
              <tr>
                <td>Total</td>
                <td id="totalCarbs"></td>
                <td id="totalProtein"></td>
                <td id="totalFats"></td>
                <td id="totalCalories"></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Right: Chart -->
      <div class="col-md-5">
        <h4 class="text-secondary">Macronutrient Breakdown</h4>
        <div class="card">
          <div class="card-header bg-primary text-white">
            Doughnut Chart
          </div>
          <div class="card-body">
            <canvas id="myChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart & Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = document.getElementById("table");
      let carbs = 0, protein = 0, fats = 0, calories = 0;

      const rows = table.querySelector("tbody").rows;

      for (let i = 0; i < rows.length; i++) {
        carbs += parseFloat(rows[i].cells[1].textContent) || 0;
        protein += parseFloat(rows[i].cells[2].textContent) || 0;
        fats += parseFloat(rows[i].cells[3].textContent) || 0;
        calories += parseFloat(rows[i].cells[4].textContent) || 0;
      }

      carbs = Math.round(carbs);
      protein = Math.round(protein);
      fats = Math.round(fats);
      calories = Math.round(calories);

      // Update totals
      document.getElementById("totalCarbs").textContent = `${carbs} g`;
      document.getElementById("totalProtein").textContent = `${protein} g`;
      document.getElementById("totalFats").textContent = `${fats} g`;
      document.getElementById("totalCalories").textContent = `${calories} Kcal`;

      // Progress bar
      const calorieGoal = 2000;
      const percentage = Math.min((calories / calorieGoal) * 100, 100);
      const progressBar = document.getElementById("calorieProgressBar");
      progressBar.style.width = percentage + "%";
      progressBar.setAttribute('aria-valuenow', Math.round(percentage));
      progressBar.textContent = Math.round(percentage) + "%";

      // Chart
      const totalMacro = carbs + protein + fats || 1;
      const carbsP = Math.round((carbs / totalMacro) * 100);
      const proteinP = Math.round((protein / totalMacro) * 100);
      const fatsP = Math.round((fats / totalMacro) * 100);

      const ctx = document.getElementById('myChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [`Carbs ${carbsP}%`, `Protein ${proteinP}%`, `Fats ${fatsP}%`],
          datasets: [{
            data: [carbsP, proteinP, fatsP],
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return `${context.label}`;
                }
              }
            }
          }
        }
      });
    });
  </script>
</body>

</html>
